<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Puzzle Poussin - Responsive & Mobile</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root{ --accent:#6d8cff; --yellow:#ffd82f; --bg1:linear-gradient(135deg,#f7eaff 0%,#fff8d6 100%);} 
    *{box-sizing:border-box}
    body{
      font-family:'Fredoka One', cursive;
      margin:0;
      background:var(--bg1);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    h1{text-align:center;color:var(--yellow);text-shadow:2px 2px 0 #6d8cff;margin:12px 0 20px}

    /* zone principale */
    #puzzle-zone {
      max-width: 95vw;
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
    }

    /* board */
    #board-wrapper {
      position: relative;
      width: 100%;
      max-width: 360px;
      aspect-ratio: 1/1; /* carrÃ© */
      margin-bottom: 14px;
    }
    #board-bg {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      object-fit: cover;
      opacity: 0.4;
    }
    #board {
      position: absolute;
      top: 0;left: 0;
      display: grid;
      width: 100%;height: 100%;
    }
    .dropzone{
      border:1px dashed rgba(255,216,47,0.45);
      background:transparent;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden
    }
    .dropzone img{width:100%;height:100%;object-fit:cover}
    .dropzone.filled{border:none}

    .dropzone.magnet{animation:magnet .5s}
    @keyframes magnet{
      0%{transform:scale(.9);box-shadow:0 0 0 #bdf5d2}
      40%{transform:scale(1.1);box-shadow:0 0 18px #48a680}
      100%{transform:scale(1)}
    }

    /* piÃ¨ces */
    #pieces {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      gap: 6px;
      width: 100%;
      max-width: 360px;
      margin-bottom: 14px;
    }
    .tile {
      width: 100%;
      aspect-ratio: 1/1;
      background:#fff8d6;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 10px #ffd82f22;
      cursor:grab;
      overflow:hidden;
      position:relative;
    }
    .tile img{width:100%;height:100%;object-fit:cover;pointer-events:none}
    .tile.dragging{opacity:0.65;transform:scale(1.05);z-index:1000}

    /* floating clone tactile */
    .float-tile{
      position:fixed;
      width:72px;height:72px;
      border-radius:8px;
      z-index:9999;
      pointer-events:none;
      box-shadow:0 6px 24px rgba(0,0,0,0.2);
      transform:translate(-50%,-50%);
    }
    .float-tile img{width:100%;height:100%;object-fit:cover}

    /* bouton */
    #reset-btn{
      display:block;
      margin: 0 auto 16px;
      background:var(--yellow);
      color:var(--accent);
      border:none;border-radius:20px;
      padding:10px 18px;font-size:1.05rem;
      cursor:pointer;
      box-shadow:0 2px 8px #ffd6f655
    }
    #reset-btn:hover{background:var(--accent);color:var(--yellow)}

    /* victoire */
    #victory{
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.85);
      display:flex;align-items:center;justify-content:center;
      z-index:200;border-radius:12px;
      animation:fadeIn .7s;
    }
    .victory-msg{
      font-size:2rem;
      color:#48a680;
      background:#fff8d6;
      border-radius:12px;
      padding:22px 28px;
      box-shadow:0 4px 32px rgba(0,0,0,0.08);
      animation:popBravo .7s
    }
    @keyframes popBravo{0%{transform:scale(.8)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>
<body>

  <h1>Puzzle requin</h1>
  <div id="puzzle-zone">
    <div id="board-wrapper">
      <img id="board-bg" src="images/animal.png" alt="fond puzzle">
      <div id="board"></div>
      <div id="victory" style="display:none;">
        <div class="victory-msg">Bravo ðŸŽ‰</div>
      </div>
    </div>

    <h2>PiÃ¨ces Ã  placer</h2>
    <div id="pieces"></div>

    <button id="reset-btn">ðŸ”„ Recommencer</button>
  </div>

  <script>
    // ---- CONFIG ----
    const IMG_SRC = "images/animal.png";
    const LEVELS = [
      {rows:3, cols:3}, // niveau facile
      {rows:4, cols:4}  // niveau suivant
    ];
    let currentLevel = 0;

    // ---- STATE ----
    let ROWS, COLS;
    let pieces = [];
    let pieceOrder = [];
    let placed = [];
    let draggedId = null;

    // ---- INIT ----
    document.addEventListener('DOMContentLoaded', () => {
      initUI();
      startLevel(0);
    });

    function initUI(){
      document.getElementById('reset-btn').addEventListener('click', ()=>startLevel(currentLevel));
    }

    async function startLevel(level){
      currentLevel = level;
      ROWS = LEVELS[level].rows;
      COLS = LEVELS[level].cols;
      await createPuzzle();
    }

    async function createPuzzle(){
      pieces = [];
      pieceOrder = [];
      placed = Array(ROWS*COLS).fill(null);
      document.getElementById('victory').style.display = 'none';

      const img = new Image();
      img.src = IMG_SRC;
      await img.decode();
      const imgPieces = await splitImageFromImage(img, ROWS, COLS);
      pieces = imgPieces;
      pieceOrder = shuffle([...pieces]);

      const boardBg = document.getElementById('board-bg');
      boardBg.src = IMG_SRC;
      await boardBg.decode();
      renderPieces();
      renderBoard();
    }

    function splitImageFromImage(img, rows, cols){
      const w = img.naturalWidth, h = img.naturalHeight;
      const arr = [];
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          const canvas = document.createElement('canvas');
          canvas.width = Math.floor(w/cols);
          canvas.height = Math.floor(h/rows);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, x*(w/cols), y*(h/rows), w/cols, h/rows, 0, 0, canvas.width, canvas.height);
          arr.push({id:`${x},${y}`, img:canvas.toDataURL(), correctPos:[x,y]});
        }
      }
      return Promise.resolve(arr);
    }

    function shuffle(a){let arr=a.slice();for(let i=arr.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}

    // ---- RENDER PIECES ----
    function renderPieces(){
      const zone = document.getElementById('pieces');
      zone.innerHTML = '';
      pieceOrder.forEach(piece => {
        if (placed.find(p=>p && p.id === piece.id)) return;
        const div = document.createElement('div');
        div.className = 'tile';
        div.draggable = true;
        div.dataset.id = piece.id;
        div.innerHTML = `<img src="${piece.img}" alt="">`;

        // desktop drag
        div.addEventListener('dragstart', (e)=>{
          draggedId = piece.id;
          div.classList.add('dragging');
          try{ e.dataTransfer.setData('text/plain', piece.id); }catch(_){}
        });
        div.addEventListener('dragend', ()=>{ draggedId = null; div.classList.remove('dragging'); });

        // tactile drag
        enableTouchDrag(div, piece);

        zone.appendChild(div);
      });
    }

    // ---- RENDER BOARD ----
    function renderBoard(){
      const board = document.getElementById('board');
      board.innerHTML = '';
      board.style.gridTemplateColumns = `repeat(${COLS}, 1fr)`;
      board.style.gridTemplateRows = `repeat(${ROWS}, 1fr)`;

      for(let y=0;y<ROWS;y++){
        for(let x=0;x<COLS;x++){
          const idx = y*COLS + x;
          const dz = document.createElement('div');
          dz.className = 'dropzone';
          dz.dataset.pos = `${x},${y}`;

          dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.style.background = '#bdf5d2'; });
          dz.addEventListener('dragleave', ()=>{ dz.style.background = 'transparent'; });
          dz.addEventListener('drop', (e)=>{
            e.preventDefault(); dz.style.background = 'transparent';
            const id = draggedId || (e.dataTransfer && e.dataTransfer.getData('text/plain'));
            if (!id) return;
            const piece = pieces.find(p=>p.id===id);
            if (!piece) return;
            handleDrop(piece, dz);
          });

          if (placed[idx]){
            dz.classList.add('filled');
            const img = document.createElement('img');
            img.src = placed[idx].img;
            dz.appendChild(img);
          }
          board.appendChild(dz);
        }
      }
    }

    // ---- DROP ----
    function handleDrop(piece, dz){
      const pos = dz.dataset.pos;
      if (piece.correctPos.join(',') === pos){
        dz.classList.add('magnet');
        setTimeout(()=>dz.classList.remove('magnet'), 600);
        const [x,y] = pos.split(',').map(Number);
        placed[y*COLS + x] = piece;
        pieceOrder = pieceOrder.filter(p=>p.id!==piece.id);
        renderPieces();
        renderBoard();
        checkVictory();
      } else {
        dz.style.borderColor = '#ff7a7a';
        dz.style.boxShadow = '0 0 12px rgba(255,0,0,0.12)';
        setTimeout(()=>{ dz.style.borderColor = 'rgba(255,216,47,0.45)'; dz.style.boxShadow='none'; }, 450);
      }
    }

    // ---- TOUCH DRAG ----
    function enableTouchDrag(tileEl, piece) {
      let clone = null;
      tileEl.addEventListener("touchstart", (e) => {
        e.preventDefault();
        const touch = e.touches[0];

        clone = document.createElement("div");
        clone.className = "float-tile";
        const img = document.createElement("img");
        img.src = piece.img;
        clone.appendChild(img);
        document.body.appendChild(clone);

        moveAt(touch.clientX, touch.clientY);

        function moveAt(x, y) {
          clone.style.left = x + "px";
          clone.style.top = y + "px";
        }

        function onMove(ev) {
          const t = ev.touches[0];
          moveAt(t.clientX, t.clientY);
        }

        function onEnd(ev) {
          const t = ev.changedTouches[0];
          const el = document.elementFromPoint(t.clientX, t.clientY);
          const dz = el ? el.closest(".dropzone") : null;
          if (dz) handleDrop(piece, dz);
          clone.remove();
          document.removeEventListener("touchmove", onMove);
          document.removeEventListener("touchend", onEnd);
        }

        document.addEventListener("touchmove", onMove);
        document.addEventListener("touchend", onEnd);
      });
    }

    // ---- VICTORY ----
    function checkVictory(){
      if (placed.every(p=>p!==null)){
        const v = document.getElementById('victory');
        v.style.display = '';
        setTimeout(()=>{
          v.style.display = 'none';
          if (currentLevel+1 < LEVELS.length){
            startLevel(currentLevel+1);
          }
        }, 1800);
      }
    }
  </script>
</body>
</html>
